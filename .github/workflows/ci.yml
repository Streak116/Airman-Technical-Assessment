name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  lint:
    name: Lint Codebase
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      - name: Install Dependencies (Web)
        run: cd apps/web && npm ci || npm install
      - name: Install Dependencies (API)
        run: cd apps/api && npm ci || npm install
      - name: Lint Web
        run: cd apps/web && npm run lint || echo "No lint script found"
      - name: Lint API
        run: cd apps/api && npm run lint || echo "No lint script found"

  test:
    name: Backend Tests (Unit & Integration)
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: admin
          POSTGRES_PASSWORD: password
          POSTGRES_DB: airman_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
    
    env:
      DATABASE_URL: postgresql://admin:password@localhost:5432/airman_test?schema=public
      JWT_SECRET: super-secret-test-key
      JWT_EXPIRES_IN: 1d
      PORT: 4000

    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      - name: Install API Dependencies
        run: cd apps/api && npm install
      - name: Run Prisma Migrations / Generate
        run: |
          cd apps/api
          npx prisma generate
          npx prisma db push --accept-data-loss
      - name: Run Unit Tests
        run: cd apps/api && npm test
      - name: Run Integration Tests
        run: cd apps/api && npm run test:int || npx jest -c jest.integration.config.js --ci

  build:
    name: Build Multi-stage Docker Images
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build Web Docker Image
        run: cd apps/web && docker build -t airman_web .
      - name: Build API Docker Image
        run: cd apps/api && docker build -t airman_api .
